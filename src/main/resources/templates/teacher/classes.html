<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head}">
    <title>My Classes - School Attendance App</title>
    <style>
        .class-card {
            transition: transform 0.2s;
        }
        .class-card:hover {
            transform: translateY(-2px);
        }
        .attendance-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .good-attendance {
            background-color: #28a745;
        }
        .warning-attendance {
            background-color: #ffc107;
        }
        .poor-attendance {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container-fluid">
    <div class="row">
        <nav th:replace="~{fragments/sidebar :: sidebar}"></nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">My Classes</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a th:href="@{/teacher/attendance}" class="btn btn-primary">
                            <i class="bi bi-calendar-check me-1"></i> Mark Attendance
                        </a>
                        <a th:href="@{/teacher/dashboard}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <div id="alert-container"></div>

            <div th:if="${!#lists.isEmpty(classes)}">
                <!-- Classes Grid -->
                <div class="row">
                    <div class="col-lg-6 col-xl-4 mb-4" th:each="class : ${classes}">
                        <div class="card class-card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <span class="attendance-indicator"
                                          th:classappend="${class.currentEnrollmentCount != null and class.currentEnrollmentCount > 0 ? 'good-attendance' : 'warning-attendance'}"></span>
                                    <span th:text="${class.name}">Class Name</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="class-details">
                                    <p class="card-text">
                                        <strong>Subject:</strong> <span th:text="${class.subject}">Subject</span><br>
                                        <strong>Grade:</strong> <span th:text="${class.gradeLevel}">Grade</span><br>
                                        <strong>Students:</strong> <span th:text="${class.currentEnrollmentCount != null ? class.currentEnrollmentCount : 0}">0</span> / <span th:text="${class.maxStudents}">0</span>
                                        <span th:if="${class.hasSpaceAvailable()}" class="badge bg-success ms-1">Space Available</span>
                                        <span th:if="${!class.hasSpaceAvailable()}" class="badge bg-warning ms-1">Full</span>
                                    </p>
                                </div>

                                <div th:if="${class.schedule != null}" class="mb-3">
                                    <small class="text-info">
                                        <i class="bi bi-clock"></i> <span th:text="${class.schedule}">Schedule</span>
                                    </small>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="bi bi-book"></i> Teacher: <span th:text="${class.teacher != null ? class.teacher.getFullName() : 'Not assigned'}">Teacher</span><br>
                                        <i class="bi bi-geo-alt"></i> <span th:text="${class.location != null ? class.location : 'No location'}">Location</span>
                                    </small>
                                </div>

                                <div class="d-grid gap-2">
                                    <a th:href="@{/teacher/attendance(classId=${class.id})}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-calendar-check me-1"></i> Mark Attendance
                                    </a>
                                    <a th:href="@{/teacher/attendance-history(classId=${class.id})}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-clock-history me-1"></i> View History
                                    </a>
                                    <a th:href="@{/teacher/booking}" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-door-open me-1"></i> Book Room
                                    </a>
                                </div>
                            </div>

                            <div class="card-footer">
                                <small class="text-muted">
                                    <i class="bi bi-calendar3"></i> Created: <span th:text="${#temporals.format(class.createdAt, 'MMM dd, yyyy')}">Date</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Teaching Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <h4 class="text-primary" th:text="${#lists.size(classes)}">0</h4>
                                            <p class="text-muted">Total Classes</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <h4 class="text-success" th:text="${#lists.size(classes.?[hasSpaceAvailable()])}">0</h4>
                                            <p class="text-muted">Available for Enrollment</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <h4 class="text-info" th:text="${classes.?[!hasSpaceAvailable()].size()}">0</h4>
                                            <p class="text-muted">Full Classes</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <h4 class="text-warning" th:text="${#aggregates.sum(classes.![currentEnrollmentCount != null ? currentEnrollmentCount : 0])}">0</h4>
                                            <p class="text-muted">Total Students</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Classes Message -->
            <div th:if="${#lists.isEmpty(classes)}" class="text-center py-5">
                <i class="bi bi-book text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">No Classes Assigned</h4>
                <p class="text-muted">You haven't been assigned any classes yet.</p>
                <p class="text-muted">Please contact the school administrator to get classes assigned.</p>
                <div class="mt-3">
                    <a href="mailto:admin@school.com" class="btn btn-primary">
                        <i class="bi bi-envelope me-2"></i>Contact Administrator
                    </a>
                </div>
            </div>

            <!-- Guidelines -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title">Class Management Guidelines:</h6>
                    <ul class="mb-0">
                        <li>Click "Mark Attendance" to record daily attendance for your classes</li>
                        <li>View "Attendance History" to track student participation over time</li>
                        <li>Use "Book Room" to schedule rooms for practical sessions and special activities</li>
                        <li>Monitor class enrollment levels and capacity</li>
                        <li>Update class information and schedules as needed</li>
                        <li>Contact administrators for class assignments or changes</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script>
// Add interactive functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to class cards
    const classCards = document.querySelectorAll('.class-card');
    classCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.boxShadow = '';
        });
    });

    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            window.location.href = '/teacher/dashboard';
        }
    });
});

// Utility function to export class information
function exportClassInfo() {
    const classes = document.querySelectorAll('.class-card');
    let classData = 'Class Name,Subject,Grade,Students,Capacity\n';

    classes.forEach(card => {
        const title = card.querySelector('.card-title')?.textContent || '';
        const details = card.querySelector('.class-details');
        if (details) {
            const text = details.textContent;
            // Extract information from the details text
            const subject = text.match(/Subject: ([^\n]+)/)?.[1] || '';
            const grade = text.match(/Grade: ([^\n]+)/)?.[1] || '';
            const students = text.match(/Students: (\d+) \/ (\d+)/)?.[1] || '0';
            const capacity = text.match(/Students: (\d+) \/ (\d+)/)?.[2] || '0';
            classData += `"${title.trim()}","${subject}","${grade}","${students}","${capacity}"\n`;
        }
    });

    // Create download link
    const blob = new Blob([classData], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `class-information-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
</body>
</html>